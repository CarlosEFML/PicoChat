pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
#include gpiolib.p8

local status="disconnected"
local menustatus=nil

local currserver="wss://server-nfim.onrender.com"
local tibkp=nil

local lines={}
local scroll=0

function bigtext(text,x,y,w,c,autoscroll)
  return {
    scx=-15,
    c=c,
    text=text,
    x=x,
    y=y,
    w=w,
    as=autoscroll
  }
end

local ti=bigtext(
  "",
  1,122,124,7
)

function initinput()
  poke(0x5f2d,1)
end

function readkb(t)
  if stat(30) then
    local c=stat(31)
    // enter
    if c=="\13" then
      poke(0x5f30,1) // supress menu
      return true
    end
    // tab = menu
    if c=="\9" then
      // cancel current option
      if menustatus then
        menustatus=nil
        restoreinput()
      else
        extcmd('pause')
      end
    // backspace
    elseif c=="\8" then 
      if(t)t.text=sub(t.text,1,#t.text-1)
    elseif c then 
      if(t)t.text=t.text..c
      // supress menu
      if(c=="p")poke(0x5f30,1)
    end
  end
  return false
end

function drawbigtext(t)
  local maxscx=#t.text*4-t.w
  if(maxscx<0)maxscx=0
  local scx=min(max(t.scx,0),maxscx)
  clip(t.x,t.y,t.w,6)
  print(t.text,t.x-scx,t.y,t.c)
  clip()
  if t.as then
    t.scx+=0.5
    if(t.scx>=(maxscx+15))t.scx=-15
  end
end

function bkpinput()
  if(tibkp==nil)tibkp=ti.text
end

function restoreinput()
  if(tibkp)ti.text=tibkp
  tibkp=nil
end

function initmenu()
  menuitem(1,"select server",
    function(b)
      bkpinput()
      ti.text=currserver
      menustatus="select server"
    end)
  menuitem(2,"disconnect",
    function(b)
      status="disconnecting"
    end)
end

function addline(text,c)
  add(lines,bigtext(text,1,0,128,c,1))
  if(#lines>40)deli(lines,1)
  if(scroll>0)setscroll(scroll+6)
end


function _init()
  initgpio()
  initinput()
  initmenu()
  addline("wellcome to picochat",7)
  addline("press tab to open menu",7)
end

function getserver()
  print("enter the server address",16,58,7)
  print("    (tab to cancel)",16,64,7)
  if readkb(ti) then
    currserver=ti.text
    restoreinput()
    menustatus=nil
    status="connecting"
  end
end

function drawheader()
  rectfill(127,6,0,0,8)
  print(status,1,1,7)
  print("⬆️⬇️ˇ",104,1,7)
end

function setscroll(scrl)
  local linesh,viewh=#lines*6,128-7-7
  local maxscrl=max(0,linesh-viewh)
  scroll=max(min(scrl,maxscrl),0)
end

function drawlines()
  if(#lines==0)return
  local lny=115+scroll
  for i=#lines,1,-1 do
    if (lny>=121) or (lny<=2) then
      lines[i].scx=-15
    else
      lines[i].y=lny
      drawbigtext(lines[i])
    end
    lny-=6
  end
end

local cursorcnt=0
function drawfooter()
  rectfill(127,127,0,121,8)
  drawbigtext(ti)
  if(#ti.text>31)ti.scx=(#ti.text-31)*4
  if cursorcnt<15 then
    local cx=min(#ti.text*4,124)
    line(cx,127,cx+3,127,7)
  end
  cursorcnt+=1
  if cursorcnt==30 then
    cursorcnt=0
  end
end

function findchar(str,char)
  for i=1,#str do
    if(str[i]==char)return i
  end
  return 0
end

function _update()
  cls(0)

  updategpio()
  local s=menustatus or status

  if s=="select server" then
    getserver()
  elseif s=="connecting" then
    status="connecting..."
    sendpack("\0"..currserver,1)
  elseif s=="disconnecting" then
    status="disconnecting..."
    sendpack({1})
  elseif s=="connected" then
    drawlines()
    if readkb(ti) then
      sendpack("\2"..ti.text,1)
      ti.text=""
      scroll=0
    end
  else
    drawlines()
    readkb()
  end
  drawheader()
  drawfooter()

  local data,len=recvpack(1)
  if len>-1 then
    local cmd=data[1]
    if cmd=="\0" then
      status="connected"
      lines={}
    elseif cmd=="\1" then
      status="disconnected"
    elseif cmd=="\2" then
      local pos=findchar(data,":")
      if pos>0 then
        user=data[1]
        addline(sub(data,2,pos),2)
        addline(sub(data,pos+2),7)
      else
        addline(sub(data,2),7)
      end
    elseif cmd=="\3" then
      addline("error :/",8)
    end
  end
  
  if(btn(0))setscroll(scroll+3)
  if(btn(1))setscroll(scroll-3)
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
66606060666006606660666000006660000066606660600066600000666066600660666066000000066066000000666060606660666000000000000000000000
60006060606060606060060000006060000060000600600060000000606060606000600060600000606060600000060060606060600006000000000000000000
66000600666060606600060000006660000066000600600066000000660066606660660060600000606060600000060066606660660000000000000000000000
60006060600060606060060000006060000060000600600060000000606060600060600060600000606060600000060000606000600006000000000000000000
66606060600066006060060000006060000060006660666066600000666060606600666066600000660060600000060066606000666000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666066000660000000000660666066606660666066600660606066606660666000000000000000000000000000000000000000000000000000000000
00000000606060606000000000006000606060600600060060006000606060006000060000000000000000000000000000000000000000000000000000000000
00000000666060606000000000006660666066000600060066006660666066006600060000000000000000000000000000000000000000000000000000000000
00000000600060606060000000000060600060600600060060000060606060006000060000000000000000000000000000000000000000000000000000000000
00000600600060606660000000006600600060606660060066606600606066606660060000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000606066606060000000000660606066606660666066006660000006606660606000000660666000006660666066606660666066606600000000000000
00000000606060606060000000006000606060606060600060600600000060006000606000006060606000006060606006000600600060606060000000000000
00000000606066606060000000006000606066006600660060600600000066606600060000006060660000006660666006000600660066006060000000000000
00000000666060606660000000006000606060606060600060600600000000606000606000006060606000006000606006000600600060606060000000000000
00000600666060600600000000000660066060606060666060600600000066006000606000006600606000006000606006000600666060606060000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666066606600000000000660666066606600660000006660600006606600666000006660666066006660666066606660066000000000000000000000
00000000606006006060000000006000060060606060606000006060600060606060600000006060060060606060606006006000600000000000000000000000
00000000660006006060000000006660060066606060606066606660600060606060660000006600060060606660660006006600666000000000000000000000
00000000606006006060000000000060060060606060606000006060600060606060600000006060060060606060606006006000006000000000000000000000
00000600666066606060000000006600060060606060666000006060666066006060666000006660666060606060606066606660660000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000606066606660600000000660666066606600660000006660600006606600666000006060666066600000666066606660000000000000000000000000
00000000606006006660600000006000060060606060606000006060600060606060600000006060600060600000606060606060000000000000000000000000
00000000666006006060600000006660060066606060606066606660600060606060660000006060660066000000666066606660000000000000000000000000
00000000606006006060600000000060060060606060606000006060600060606060600000006660600060600000606060006000000000000000000000000000
00000600606006006060666000006600060060606060666000006060666066006060666000006660666066600000606060006000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666066600000666066000660000000000000066066606060666000006660000006600660666060600000000000000000000000000000000000000000
00000000606060600000606060606000000000000000600060606060600000006060000060006060606060600000000000000000000000000000000000000000
00000000666066600000666060606000000000000000666066606060660000006660000060006060666066600000000000000000000000000000000000000000
00000000600060600000600060606060000000000000006060606660600000006060000060006060600000600000000000000000000000000000000000000000
00000600600066600600600060606660000000000000660060600600666000006060000006606600600066600000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000666066606660000066606600066000000000666066606660000060606660066060606660600066600660666066606660066066000000000000000000
00000000666060606060000060606060600000000000666060606060000060600600600060606060600006006000606006000600606060600000000000000000
00000000606066606660000066606060600000000000606066606660000060600600666060606660600006006660666006000600606060600000000000000000
00000000606060606000000060006060606000000000606060606000000066600600006060606060600006000060606006000600606060600000000000000000
00000600606060606000060060006060666000000000606060606000000006006660660006606060666066606600606006006660660060600000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66606060666006606660666000006000666066606660600000000000000000000000000000000000000000000000000000000000000000000000000000000000
60006060606060606060060000006000606060606000600006000000000000000000000000000000000000000000000000000000000000000000000000000000
66000600666060606600060000006000666066006600600000000000000000000000000000000000000000000000000000000000000000000000000000000000
60006060600060606060060000006000606060606000600006000000000000000000000000000000000000000000000000000000000000000000000000000000
66606060600066006060060000006660606066606660666000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70000000777070707770077077707770000000007000000070007770777077707000000077707700077000000000000000000000000000000000000000000000
07000000700070707070707070700700000000007000000070007070707070007000000070707070700000000000000000000000000000000000000000000000
00700000770007007770707077000700000077707000000070007770770077007000000077707070700000000000000000000000000000000000000000000000
07000000700070707000707070700700000000007000000070007070707070007000000070007070707000000000000000000000000000000000000000000000
70000000777070707000770070700700000000007770000077707070777077707770070070007070777000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66606660660060600000000066600660666000006660066066606660666066600000060006600660660066600000066066006000606006000000000000000000
06000600606060600000000060606060666000006000606060606660606006000000600060006060606060000000606060606000606000600600000000000000
06000600606066600000000066006060606000006600606066006060666006000000600060006060606066000000606060606000666000600000000000000000
06000600606000600000000060606060606000006000606060606060606006000000600060006060606060000000606060606000006000600600000000000000
06006660606066600000060060606600606000006000660060606060606006000000060006606600666066600000660060606660666006000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70000000777070707770077077707770000000007770000077700770077000007770777000007770077077700000000000000000000000000000000000000000
07000000700070707070707070700700000000000700000070007070707000007070707000007070707077700000000000000000000000000000000000000000
00700000770007007770707077000700000077700700000077007070707000007770777000007700707070700000000000000000000000000000000000000000
07000000700070707000707070700700000000000700000070007070707000007000707000007070707070700000000000000000000000000000000000000000
70000000777070707000770070700700000000000700000070007700770007007000777007007070770070700000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66606660660066606660606000006660606060006660666006606660666066600000000000000000000000000000000000000000000000000000000000000000
60600600606060606060606000006660606060000600060060006060606006000600000000000000000000000000000000000000000000000000000000000000
66000600606066606600666000006060606060000600060060006660660006000000000000000000000000000000000000000000000000000000000000000000
60600600606060606060006000006060606060000600060060006060606006000600000000000000000000000000000000000000000000000000000000000000
66606660606060606060666000006060066066600600666006606060606006000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70000000777070707770077077707770000077700770077000007770777077000000077077707770777077700000777077700000077077700000777077700000
07000000700070707070707070700700000070007070707000007070070070700000700070707070070000700000707070700000700000700000707070700000
00700000770007007770707077000700000077007070707000007700070070700000700077707700070077700000777077700000700007700000777077700000
07000000700070707000707070700700000070007070707000007070070070700000700070707070070070000000700070700000700000700000700070700000
70000000777070707000770070700700000070007700770007007770777070700000077070707070070077700700700077700000077077700700700077700000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70000000777070707770077077707770000077707770077077700000707077707770700000007770777007707770000077707770000000000000000000000000
07000000700070707070707070700700000007007000700007000000707007007770700000000700700070000700000070707070000000000000000000000000
00700000770007007770707077000700000007007700777007000000777007007070700000000700770077700700000077707770000000000000000000000000
07000000700070707000707070700700000007007000007007000000707007007070700000000700700000700700000070007070000000000000000000000000
70000000777070707000770070700700000007007770770007000700707007007070777000000700777077000700070070007770000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66606000666066600660666000000660666066606660606066606660000066600000600066606660666060000000666066606660066066600000000000000000
60606000600060606000600000006000606060600600606060606000000060600000600060606060600060000000600006006060600006000000000000000000
66606000660066606660660000006000666066600600606066006600000066600000600066606600660060000000660006006600666006000000000000000000
60006000600060600060600000006000606060000600606060606000000060600000600060606060600060000000600006006060006006000000000000000000
60006660666060606600666000000660606060000600066060606660000060600000666060606660666066600000600066606060660006000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

